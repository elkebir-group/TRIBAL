
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../clonotype/">
      
      
        <link rel="next" href="../lineagetree/">
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.30">
    
    
      
        <title>Tribal - TRIBAL</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.3cba04c6.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="brown" data-md-color-accent="deep-purple">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#tribal" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="TRIBAL" class="md-header__button md-logo" aria-label="TRIBAL" data-md-component="logo">
      
  <img src="../../img/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            TRIBAL
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Tribal
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/elkebir-group/TRIBAL" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  About

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../setup/install/" class="md-tabs__link">
          
  
  Usage

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../preprocess/" class="md-tabs__link">
          
  
  API

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="TRIBAL" class="md-nav__button md-logo" aria-label="TRIBAL" data-md-component="logo">
      
  <img src="../../img/logo.png" alt="logo">

    </a>
    TRIBAL
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/elkebir-group/TRIBAL" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    About
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Usage
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Usage
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../setup/install/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Download & Installation
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../setup/data/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Data
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../setup/package/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Package Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../setup/cli/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Command Line Interface
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    API
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            API
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../preprocess/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Preprocesssing
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../base_tree/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    BaseTree
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../clonotype/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Clonotype
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Tribal
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Tribal
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#tribal.Tribal" class="md-nav__link">
    <span class="md-ellipsis">
      Tribal
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tribal.Tribal.fit" class="md-nav__link">
    <span class="md-ellipsis">
      fit
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lineagetree/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    LineageTree
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lineagetreelist/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    LineageTreeList
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="tribal">Tribal<a class="headerlink" href="#tribal" title="Permanent link">&para;</a></h1>


<div class="doc doc-object doc-class">



<a id="tribal.Tribal"></a>
    <div class="doc doc-contents first">


      <p>A class to infer a B cell lineage tree for each clonotype and shared isotype transition probabilities. </p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="tribal.Tribal.n_isotypes">n_isotypes</span></code></td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the number of isotype states</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="tribal.Tribal.alphabet">alphabet</span></code></td>
            <td>
                  <code>tuple</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the valid alphabet for BCR sequences, defaults to  ("A", "C", "G", "T","N", "-")</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="tribal.Tribal.sankoff_cost_function">sankoff_cost_function</span></code></td>
            <td>
                  <code>dict</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the cost function to use for running the Sankoff algorithm during ancestral BCR sequence reconstruction.
the keys must be all pairs from the provided alphabet. defaults to using the standard cost
function (1 for a mismatch, 0 for match)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="tribal.Tribal.seed">seed</span></code></td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>random number seed used to randomly downsample candidate trees within each iterations when size of a parsimony forests
is greater than max_cand</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="tribal.Tribal.max_cand">max_cand</span></code></td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the maximum allowable size of a parsimony forest to consider within each coordinate descent iterations.
if the size of each maximum parsimony forest is less than max_cand then downsampling does not occur.
niter: int
the maximum number of coordinate descent iterations to perform if convergence criteria is not met, defaults to 10)</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="tribal.Tribal.threshold">threshold</span></code></td>
            <td>
                  <code>float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The tolerance for convergence of the CSR objective, defaults to 0.5</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="tribal.Tribal.restarts">restarts</span></code></td>
            <td>
                  <code>int</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the number of restarts, i.e, different initialization of the isotype transition probabilities, defaults to 10</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="tribal.Tribal.stay_probs">stay_probs</span></code></td>
            <td>
                  <code>tuple</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the lower bound and upper bound for the initialization of the probability of not class switching.
the initalization values of this parameter are determined by using np.linspace on this range with the
restarts parameter, defaults to (0.55, 0.95)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Notes</summary>
  <p>TRIBAL takes as input a maximum parsimony forest (a set of trees that minimizes the SHM score for a 
multiple sequenced alignment of the concatentated heavy and light chain (optional) variable
region sequences) and the encoded isotype of each sequenced B cell for k clonotypes.   See the Preprocessor class for help preparing the input data. 
It then infers a B cell lineage tree(s) for each clonotype that minimizes the somatic hypermutation (SHM) parsimony score and then maximizes the class swtich recombination (CSR)
likelihood score. It also infers the optimal isotype transition probabilities that jointly maximizes the CSR likelihood.</p>
<p>TRIBAL uses a coordinate ascent algorithm to alternately infer the optimal isotype transition probabilities and then
infer a representative B cell lineage tree for each clonotype. This proceeds until the CSR likelihood objective
convergences within a tolerance defined by threshold. Multiple restarts are performed with different initial
isotype transition probabilities. The initializations are defined by the stay_probs, a tuple of floats the defines
an upper and lower bound on the diagonal of the isotype transition probability matrix. Given a number of restarts and stay probs, 
np.linspace(lower bound, upper bound, restarts) is used to define a stay probability, i.e., the probability of 
not class switching, for each restart. The remain entries in each row are either 0 if the transition violates
class switching constraints, e.g., IgG -&gt; IgM, or initialized uniformly (1 - stay_prob)/# of valid transitions from start 
state. </p>
<p>The default mode for TRIBAL if 'refinement', during the coordinate descent step TRIBAL will find the 
most parsimonious tree refinement of each tree  in the maximum parsimony forest and ancestral isotypes given the current isotype transition probabilites.
In score mode, TRIBAL will not modify the input maximum parsimony trees and will only infer the ancestral
isotypes using the Sankoff algorithm with a cost function given by the negative log of the isotype
transition probabilities. </p>
<p>If the size the of the maximum parsimony forest is very large, the parsimony forest can optionally
be downsampled to a size of max_cand during each iteration of the algorithm. The best tree found so far is always included
in the next iteration to ensure convergence. </p>
</details>

<p><span class="doc-section-title">Examples:</span></p>
    <p>Here is an example of how to use the TRIBAL class::</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">tribal</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">Tribal</span><span class="p">,</span><span class="w"> </span><span class="n">clonotypes</span>

<span class="c1">#clonotypes dictionary includes the following clonotypes</span>
<span class="c1">#[&quot;Clonotype_1036&quot;, &quot;Clonotype_1050&quot;, &quot;Clonotype_10884&quot;,&quot;Clonotype_1457&quot;, &quot;Clonotype_755&quot;, &quot;Clonotype_322&quot;]</span>

<span class="c1">#the clonotype data contains the following isotypes encoded from 0 to 7</span>
<span class="n">isotypes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;IGHM&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;IGHG3&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;IGHG1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;IGHA1&#39;</span><span class="p">,</span><span class="s1">&#39;IGHG2&#39;</span><span class="p">,</span><span class="s1">&#39;IGHG4&#39;</span><span class="p">,</span><span class="s1">&#39;IGHE&#39;</span><span class="p">,</span><span class="s1">&#39;IGHA2&#39;</span><span class="p">]</span>
<span class="n">tr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Tribal</span><span class="p">(</span><span class="n">n_isotypes</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">isotypes</span><span class="p">),</span><span class="w"> </span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="w"> </span><span class="n">restarts</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">niter</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

<span class="c1">#run in refinement mode</span>
<span class="n">shm_score</span><span class="p">,</span><span class="w"> </span><span class="n">csr_likelihood</span><span class="p">,</span><span class="w"> </span><span class="n">best_scores</span><span class="p">,</span><span class="w"> </span><span class="n">transmat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">clonotypes</span><span class="o">=</span><span class="n">clonotypes</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;refinement&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">cores</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
</code></pre></div>

              <details class="quote">
                <summary>Source code in <code>tribal/tribal.py</code></summary>
                <div class="codehilite"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">Tribal</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class to infer a B cell lineage tree for each clonotype and shared isotype transition probabilities. </span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    n_isotypes : int</span>
<span class="sd">       the number of isotype states</span>
<span class="sd">    alphabet : tuple</span>
<span class="sd">        the valid alphabet for BCR sequences, defaults to  (&quot;A&quot;, &quot;C&quot;, &quot;G&quot;, &quot;T&quot;,&quot;N&quot;, &quot;-&quot;)</span>
<span class="sd">    sankoff_cost_function : dict</span>
<span class="sd">        the cost function to use for running the Sankoff algorithm during ancestral BCR sequence reconstruction.</span>
<span class="sd">        the keys must be all pairs from the provided alphabet. defaults to using the standard cost</span>
<span class="sd">        function (1 for a mismatch, 0 for match)</span>
<span class="sd">    seed: int</span>
<span class="sd">        random number seed used to randomly downsample candidate trees within each iterations when size of a parsimony forests</span>
<span class="sd">        is greater than max_cand</span>
<span class="sd">    max_cand: int</span>
<span class="sd">        the maximum allowable size of a parsimony forest to consider within each coordinate descent iterations.</span>
<span class="sd">        if the size of each maximum parsimony forest is less than max_cand then downsampling does not occur.</span>
<span class="sd">     niter: int</span>
<span class="sd">        the maximum number of coordinate descent iterations to perform if convergence criteria is not met, defaults to 10)</span>
<span class="sd">    threshold : float</span>
<span class="sd">        The tolerance for convergence of the CSR objective, defaults to 0.5</span>
<span class="sd">    restarts : int</span>
<span class="sd">        the number of restarts, i.e, different initialization of the isotype transition probabilities, defaults to 10</span>
<span class="sd">    stay_probs : tuple</span>
<span class="sd">        the lower bound and upper bound for the initialization of the probability of not class switching.</span>
<span class="sd">        the initalization values of this parameter are determined by using np.linspace on this range with the</span>
<span class="sd">        restarts parameter, defaults to (0.55, 0.95)</span>

<span class="sd">    Notes</span>
<span class="sd">    ----</span>
<span class="sd">    TRIBAL takes as input a maximum parsimony forest (a set of trees that minimizes the SHM score for a </span>
<span class="sd">    multiple sequenced alignment of the concatentated heavy and light chain (optional) variable</span>
<span class="sd">    region sequences) and the encoded isotype of each sequenced B cell for k clonotypes.   See the Preprocessor class for help preparing the input data. </span>
<span class="sd">    It then infers a B cell lineage tree(s) for each clonotype that minimizes the somatic hypermutation (SHM) parsimony score and then maximizes the class swtich recombination (CSR)</span>
<span class="sd">    likelihood score. It also infers the optimal isotype transition probabilities that jointly maximizes the CSR likelihood.</span>

<span class="sd">    TRIBAL uses a coordinate ascent algorithm to alternately infer the optimal isotype transition probabilities and then</span>
<span class="sd">    infer a representative B cell lineage tree for each clonotype. This proceeds until the CSR likelihood objective</span>
<span class="sd">    convergences within a tolerance defined by threshold. Multiple restarts are performed with different initial</span>
<span class="sd">    isotype transition probabilities. The initializations are defined by the stay_probs, a tuple of floats the defines</span>
<span class="sd">    an upper and lower bound on the diagonal of the isotype transition probability matrix. Given a number of restarts and stay probs, </span>
<span class="sd">    np.linspace(lower bound, upper bound, restarts) is used to define a stay probability, i.e., the probability of </span>
<span class="sd">    not class switching, for each restart. The remain entries in each row are either 0 if the transition violates</span>
<span class="sd">    class switching constraints, e.g., IgG -&gt; IgM, or initialized uniformly (1 - stay_prob)/# of valid transitions from start </span>
<span class="sd">    state. </span>

<span class="sd">    The default mode for TRIBAL if &#39;refinement&#39;, during the coordinate descent step TRIBAL will find the </span>
<span class="sd">    most parsimonious tree refinement of each tree  in the maximum parsimony forest and ancestral isotypes given the current isotype transition probabilites.</span>
<span class="sd">    In score mode, TRIBAL will not modify the input maximum parsimony trees and will only infer the ancestral</span>
<span class="sd">    isotypes using the Sankoff algorithm with a cost function given by the negative log of the isotype</span>
<span class="sd">    transition probabilities. </span>


<span class="sd">    If the size the of the maximum parsimony forest is very large, the parsimony forest can optionally</span>
<span class="sd">    be downsampled to a size of max_cand during each iteration of the algorithm. The best tree found so far is always included</span>
<span class="sd">    in the next iteration to ensure convergence. </span>


<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    Here is an example of how to use the TRIBAL class::</span>

<span class="sd">        from tribal import Tribal, clonotypes</span>

<span class="sd">        #clonotypes dictionary includes the following clonotypes</span>
<span class="sd">        #[&quot;Clonotype_1036&quot;, &quot;Clonotype_1050&quot;, &quot;Clonotype_10884&quot;,&quot;Clonotype_1457&quot;, &quot;Clonotype_755&quot;, &quot;Clonotype_322&quot;]</span>

<span class="sd">        #the clonotype data contains the following isotypes encoded from 0 to 7</span>
<span class="sd">        isotypes = [&#39;IGHM&#39;, &#39;IGHG3&#39;, &#39;IGHG1&#39;, &#39;IGHA1&#39;,&#39;IGHG2&#39;,&#39;IGHG4&#39;,&#39;IGHE&#39;,&#39;IGHA2&#39;]</span>
<span class="sd">        tr = Tribal(n_isotypes=len(isotypes), verbose=True, restarts=2, niter=15)</span>

<span class="sd">        #run in refinement mode</span>
<span class="sd">        shm_score, csr_likelihood, best_scores, transmat = tr.fit(clonotypes=clonotypes, mode=&quot;refinement&quot;, cores=6)</span>


<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">n_isotypes</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
                <span class="n">alphabet</span><span class="o">=</span> <span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;G&quot;</span><span class="p">,</span> <span class="s2">&quot;T&quot;</span><span class="p">,</span><span class="s2">&quot;N&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">),</span>
                <span class="n">sankoff_cost_function</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                <span class="n">seed</span><span class="o">=</span> <span class="mi">1026</span><span class="p">,</span> 
                <span class="n">max_cand</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> 
                <span class="n">niter</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                <span class="n">threshold</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                <span class="n">restarts</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                <span class="n">stay_probs</span><span class="o">=</span><span class="p">(</span><span class="mf">0.55</span><span class="p">,</span><span class="mf">0.95</span><span class="p">),</span> 
                <span class="n">verbose</span> <span class="o">=</span><span class="kc">False</span> <span class="p">):</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">n_isotypes</span> <span class="o">=</span> <span class="n">n_isotypes</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">alphabet</span> <span class="o">=</span> <span class="n">alphabet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sankoff_cost_function</span> <span class="o">=</span> <span class="n">sankoff_cost_function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stay_probs</span> <span class="o">=</span> <span class="n">stay_probs</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">max_cand</span> <span class="o">=</span> <span class="n">max_cand</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">niterations</span> <span class="o">=</span> <span class="n">niter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restarts</span> <span class="o">=</span> <span class="n">restarts</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span>  <span class="o">=</span> <span class="n">verbose</span> 

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="n">param_str</span>  <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">TRIBAL parameters:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">param_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;number of isotypes: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">n_isotypes</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">param_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;sequence alphabet: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">alphabet</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">param_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;maximum candidates: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">max_cand</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">param_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;stay probabilities: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">stay_probs</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">param_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;random number seed: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">param_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;restarts: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">restarts</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">param_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;iterations: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">niterations</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">param_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;convergence threshold: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">param_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;verbose: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

            <span class="nb">print</span><span class="p">(</span><span class="n">param_str</span><span class="p">)</span>








    <span class="k">def</span> <span class="nf">_intialize_candidates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clonotypes</span><span class="p">,</span> <span class="n">best_tree_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># &#39;&#39;&#39;</span>
        <span class="c1"># randomly initialize a set of candidate trees up to max_cands </span>
        <span class="c1"># for each clonotype, including the best trees found so far is dictionary</span>
        <span class="c1"># is given.&#39;&#39;&#39;</span>

        <span class="n">candidates</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">clonotypes</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">clonotypes</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_cand</span><span class="p">:</span>
                <span class="n">cand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rng</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">clonotypes</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_cand</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cand</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">clonotypes</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">())]</span>

            <span class="n">candidates</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">=</span> <span class="n">Clonotype</span><span class="p">(</span><span class="nb">id</span> <span class="o">=</span> <span class="n">clonotypes</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">alignment</span><span class="o">=</span><span class="n">clonotypes</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">alignment</span><span class="p">,</span> <span class="n">isotypes</span><span class="o">=</span><span class="n">clonotypes</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">isotypes</span><span class="p">)</span>

            <span class="c1">#TODO: remove deep copy</span>
            <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">cand</span><span class="p">:</span>
                <span class="n">candidates</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">clonotypes</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">index</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">best_tree_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">best_tree_ids</span><span class="p">[</span><span class="n">c</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cand</span><span class="p">:</span>
                        <span class="n">candidates</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">clonotypes</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">candidates</span> 


    <span class="k">def</span> <span class="nf">_csr_optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">candidates</span><span class="p">,</span> <span class="n">transmat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>


            <span class="c1">#forest returns dict with clonotype as key and LineageTreeList as value</span>
            <span class="n">all_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_forest_mode</span><span class="p">(</span><span class="n">candidates</span><span class="p">,</span> <span class="n">transmat</span><span class="p">)</span>

            <span class="n">top_scores</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">total_likelihood</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">sl</span> <span class="ow">in</span> <span class="n">all_scores</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">best_obj</span><span class="p">,</span> <span class="n">best_scores</span> <span class="o">=</span> <span class="n">sl</span><span class="o">.</span><span class="n">find_all_best_trees</span><span class="p">()</span>
                <span class="n">top_scores</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">best_scores</span>
                <span class="n">total_likelihood</span> <span class="o">+=</span> <span class="n">best_obj</span>
            <span class="k">return</span> <span class="n">total_likelihood</span><span class="p">,</span> <span class="n">top_scores</span>


    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_check_convergence</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">new</span><span class="p">,</span> <span class="n">threshold</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">old</span> <span class="o">-</span><span class="n">new</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">threshold</span>


    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clonotypes</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;refinement&quot;</span><span class="p">,</span> <span class="n">transmat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cores</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run TRIBAL on a dictionary of clonotypes and infer B cell lineage tree(s)</span>
<span class="sd">        for each clonotype and a shared istoype transition probability matrix. </span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        clonotypes: dict</span>
<span class="sd">            a dictionary of Clonotypes each containing a parsimony forest, isotypes and multiple sequence alignment    </span>
<span class="sd">        mode: str</span>
<span class="sd">            the mode for optimizing the class switch recombination (CSR) likelihood, one of [&quot;refinement&quot;, &quot;score&quot;]. In</span>
<span class="sd">            &#39;refinement&#39; mode, TRIBAL solves the most parsiminious tree refinement (MPTR) problem for each </span>
<span class="sd">            candidate tree in the parsimony forest. In &#39;score&#39; mode, TRIBAL  infers the ancestral isotypes using</span>
<span class="sd">            the Sankoff algorithm with the weights coming from the isotype transition probabilities. </span>
<span class="sd">        transmat: list</span>
<span class="sd">            a optional isotype transition probabilty matrix to infer a B cell lineage</span>
<span class="sd">            tree(s) for each clonotype. If not provided, the isotype transition probabilites</span>
<span class="sd">            are inferred from the data. </span>

<span class="sd">        cores: int</span>
<span class="sd">            The number of cores to use (default 1)</span>



<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        Here are examples of how to run the fit function::</span>

<span class="sd">            from tribal import Tribal, clonotypes</span>

<span class="sd">            #clonotypes dictionary includes the following clonotypes</span>
<span class="sd">            #[&quot;Clonotype_1036&quot;, &quot;Clonotype_1050&quot;, &quot;Clonotype_10884&quot;,&quot;Clonotype_1457&quot;, &quot;Clonotype_755&quot;, &quot;Clonotype_322&quot;]</span>

<span class="sd">            isotypes = [&#39;IGHM&#39;, &#39;IGHG3&#39;, &#39;IGHG1&#39;, &#39;IGHA1&#39;,&#39;IGHG2&#39;,&#39;IGHG4&#39;,&#39;IGHE&#39;,&#39;IGHA2&#39;]</span>
<span class="sd">            tr = Tribal(n_isotypes=len(isotypes), verbose=True, restarts=2, niter=15)</span>

<span class="sd">            #run in refinement mode</span>
<span class="sd">            shm_score, csr_likelihood, best_scores, transmat = tr.fit(clonotypes=clonotypes, mode=&quot;refinement&quot;, cores=6)</span>

<span class="sd">            #run in scoring mode</span>
<span class="sd">            shm_score, csr_likelihood, best_scores, transmat = tr.fit(clonotypes=clonotypes, mode=&quot;score&quot;, cores=6)</span>


<span class="sd">            #given a user-specified isotype transition probability matrix </span>
<span class="sd">            from tribal import probabilites</span>
<span class="sd">            shm_score, csr_likelihood, best_scores, transmat = tr.fit(clonotypes =clonotypes,</span>
<span class="sd">                                                                        transmat= probabilites,</span>
<span class="sd">                                                                        mode=&quot;refinement&quot;, cores=6)</span>



<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        shm_score: float</span>
<span class="sd">            a float with the total somatic hypermutation (SHM) parsimony score for all clonotypes</span>

<span class="sd">        csr_likelihood: float</span>
<span class="sd">            a float with the total class switch recombination (CSR) likelihood score for all clonotypes</span>

<span class="sd">        best_scores: dict </span>
<span class="sd">            a dictionary of LineageTreeLists containing all optimal LineageTrees per clonotype</span>

<span class="sd">        transmat: np.array</span>
<span class="sd">            a numpy array of isotype transition probabilities</span>


<span class="sd">        &quot;&quot;&quot;</span>




        <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">nproc</span> <span class="o">=</span> <span class="n">cores</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clonotypes</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The number of clonotypes is 0. Recheck data and try again.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Starting TRIBAL with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">clonotypes</span><span class="p">)</span><span class="si">}</span><span class="s2"> clonotypes...&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">transmat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Inferring isotype transition probabilities...&quot;</span><span class="p">)</span>
            <span class="n">transmat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infer_probabilities</span><span class="p">(</span><span class="n">clonotypes</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using provided isotype transition probabilities for CSR optimization...&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">transmat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_isotypes</span> <span class="ow">or</span> <span class="n">transmat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_isotypes</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;User provided isotype transition probability matrix does not match the number of isotype states&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Optimizing the CSR Likelihood...&quot;</span><span class="p">)</span>
        <span class="n">csr_likelihood</span><span class="p">,</span> <span class="n">best_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_csr_optimize</span><span class="p">(</span><span class="n">clonotypes</span><span class="p">,</span> <span class="n">transmat</span><span class="o">=</span><span class="n">transmat</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reconstructing the ancestral sequences...&quot;</span><span class="p">)</span>

        <span class="n">shm_score</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">bst_lst</span> <span class="ow">in</span> <span class="n">best_scores</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">alignment</span> <span class="o">=</span> <span class="n">clonotypes</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">alignment</span>
            <span class="n">min_score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">Inf</span>
            <span class="k">for</span> <span class="n">lt</span> <span class="ow">in</span> <span class="n">bst_lst</span><span class="p">:</span>
                <span class="n">lt</span><span class="o">.</span><span class="n">ancestral_sequence_reconstruction</span><span class="p">(</span><span class="n">alignment</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alphabet</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">lt</span><span class="o">.</span><span class="n">shm_obj</span> <span class="o">&lt;</span> <span class="n">min_score</span><span class="p">:</span>
                    <span class="n">min_score</span> <span class="o">=</span> <span class="n">lt</span><span class="o">.</span><span class="n">shm_obj</span>
            <span class="n">shm_score</span> <span class="o">+=</span> <span class="n">min_score</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SHM Score: </span><span class="si">{</span><span class="n">shm_score</span><span class="si">}</span><span class="s2"> CSR Likelihood: </span><span class="si">{</span><span class="n">csr_likelihood</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The TRIBE has spoken!&quot;</span><span class="p">)</span>
        <span class="k">return</span>  <span class="n">shm_score</span><span class="p">,</span> <span class="n">csr_likelihood</span><span class="p">,</span> <span class="n">best_scores</span><span class="p">,</span> <span class="n">transmat</span>





    <span class="k">def</span> <span class="nf">_infer_probabilities</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clonotypes</span><span class="p">):</span>


<span class="w">        </span><span class="sd">&#39;&#39;&#39; </span>
<span class="sd">            jointly infer isotype transition probabilities for a set of clonotypes</span>
<span class="sd">            and a B cell lineage tree that maximizes the CSR likelihood</span>

<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">cand_tmat</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cand_scores</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">best_trees</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">stay_probs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">stay_probs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">restarts</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">restarts</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Starting restart </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>

            <span class="n">transmat</span> <span class="o">=</span>  <span class="n">gen_trans_mat</span><span class="p">(</span><span class="n">stay_probs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_isotypes</span><span class="p">)</span>
            <span class="n">best_tree_ids</span> <span class="o">=</span> <span class="kc">None</span> 
            <span class="n">old_score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">Inf</span>

            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">niterations</span><span class="p">):</span>

                <span class="n">candidates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_intialize_candidates</span><span class="p">(</span><span class="n">clonotypes</span><span class="p">,</span> <span class="n">best_tree_ids</span><span class="p">)</span>
                <span class="n">current_score</span><span class="p">,</span> <span class="n">all_best_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_csr_optimize</span><span class="p">(</span><span class="n">candidates</span><span class="p">,</span> <span class="n">transmat</span><span class="o">=</span><span class="n">transmat</span><span class="p">)</span>
                <span class="c1"># all_best_scores.append(best_scores)</span>


                <span class="n">best_tree_ids</span> <span class="o">=</span>  <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="n">all_best_scores</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">_get_ids</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">all_best_scores</span><span class="p">}</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;iteration: </span><span class="si">{</span><span class="n">j</span><span class="si">}</span><span class="s2"> old score: </span><span class="si">{</span><span class="n">old_score</span><span class="si">}</span><span class="s2"> current score: </span><span class="si">{</span><span class="n">current_score</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_convergence</span><span class="p">(</span><span class="n">current_score</span><span class="p">,</span> <span class="n">old_score</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">)</span> <span class="ow">or</span> <span class="n">j</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">niterations</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">cand_tmat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transmat</span><span class="p">)</span>
                        <span class="n">cand_scores</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_score</span><span class="p">)</span>
                        <span class="n">best_trees</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">all_best_scores</span><span class="p">)</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">old_score</span> <span class="o">=</span> <span class="n">current_score</span>
                    <span class="n">transmat</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">MaxLike</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_isotypes</span><span class="p">)</span><span class="o">.</span><span class="n">infer</span><span class="p">(</span><span class="n">all_best_scores</span><span class="p">)</span> 

        <span class="n">min_value</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">cand_scores</span><span class="p">)</span>
        <span class="n">min_index</span> <span class="o">=</span> <span class="n">cand_scores</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">min_value</span><span class="p">)</span>
        <span class="n">transmat</span> <span class="o">=</span> <span class="n">cand_tmat</span><span class="p">[</span><span class="n">min_index</span><span class="p">]</span>

        <span class="k">return</span>  <span class="n">transmat</span>



    <span class="c1">#candidates should be a dict of lineage forests with clonotypes as key</span>
    <span class="k">def</span> <span class="nf">_forest_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>  <span class="n">candidates</span><span class="p">,</span> <span class="n">transmat</span><span class="p">):</span>

            <span class="n">arg_vals</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
                <span class="n">lin_forest</span> <span class="o">=</span> <span class="n">candidates</span><span class="p">[</span><span class="n">c</span><span class="p">]</span>
                <span class="n">isotype_labels</span> <span class="o">=</span> <span class="n">lin_forest</span><span class="o">.</span><span class="n">isotypes</span> 
                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">lin_forest</span><span class="o">.</span><span class="n">get_forest</span><span class="p">():</span>
                    <span class="n">lt</span> <span class="o">=</span> <span class="n">LineageTree</span><span class="p">(</span><span class="n">clonotype</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">tree</span><span class="o">=</span><span class="n">t</span><span class="p">)</span>
                    <span class="n">arg_vals</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">transmat</span><span class="p">,</span> <span class="n">lt</span><span class="p">,</span> <span class="n">isotype_labels</span> <span class="p">))</span>


            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s2">&quot;refinement&quot;</span><span class="p">:</span>
                <span class="n">mode_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_refine</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mode_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_score</span> 


            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nproc</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">mode_func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="k">for</span> <span class="n">args</span> <span class="ow">in</span> <span class="n">arg_vals</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">Pool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nproc</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
                    <span class="n">results</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="n">mode_func</span><span class="p">,</span> <span class="n">arg_vals</span><span class="p">)</span> 

            <span class="n">all_scores</span> <span class="o">=</span> <span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="n">LineageTreeList</span><span class="p">()</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">}</span>
            <span class="k">for</span> <span class="n">lt</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="n">all_scores</span><span class="p">[</span><span class="n">lt</span><span class="o">.</span><span class="n">clonotype</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">lt</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">all_scores</span>




    <span class="k">def</span> <span class="nf">_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transmat</span><span class="p">,</span> <span class="n">lt</span><span class="p">,</span> <span class="n">isotype_labels</span><span class="p">):</span>
        <span class="n">lt</span><span class="o">.</span><span class="n">isotype_parsimony</span><span class="p">(</span><span class="n">isotype_labels</span><span class="p">,</span> <span class="n">transmat</span><span class="o">=</span><span class="n">transmat</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lt</span> 




    <span class="k">def</span> <span class="nf">_refine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transmat</span><span class="p">,</span> <span class="n">lt</span><span class="p">,</span> <span class="n">isotype_labels</span><span class="p">):</span>
        <span class="n">lt</span><span class="o">.</span><span class="n">refinement</span><span class="p">(</span><span class="n">isotype_labels</span><span class="p">,</span> <span class="n">transmat</span><span class="o">=</span><span class="n">transmat</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lt</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h2 id="tribal.Tribal.fit" class="doc doc-heading">
            <code class=" language-python"><span class="n">fit</span><span class="p">(</span><span class="n">clonotypes</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;refinement&#39;</span><span class="p">,</span> <span class="n">transmat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cores</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></code>

<a href="#tribal.Tribal.fit" class="headerlink" title="Permanent link">&para;</a></h2>


    <div class="doc doc-contents ">

      <p>Run TRIBAL on a dictionary of clonotypes and infer B cell lineage tree(s)
for each clonotype and a shared istoype transition probability matrix. </p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code>clonotypes</code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>a dictionary of Clonotypes each containing a parsimony forest, isotypes and multiple sequence alignment</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>mode</code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the mode for optimizing the class switch recombination (CSR) likelihood, one of ["refinement", "score"]. In
'refinement' mode, TRIBAL solves the most parsiminious tree refinement (MPTR) problem for each 
candidate tree in the parsimony forest. In 'score' mode, TRIBAL  infers the ancestral isotypes using
the Sankoff algorithm with the weights coming from the isotype transition probabilities.</p>
              </div>
            </td>
            <td>
                  <code>&#39;refinement&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>transmat</code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>a optional isotype transition probabilty matrix to infer a B cell lineage
tree(s) for each clonotype. If not provided, the isotype transition probabilites
are inferred from the data.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code>cores</code></td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The number of cores to use (default 1)</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Examples:</span></p>
    <p>Here are examples of how to run the fit function::</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">tribal</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">Tribal</span><span class="p">,</span><span class="w"> </span><span class="n">clonotypes</span>

<span class="c1">#clonotypes dictionary includes the following clonotypes</span>
<span class="c1">#[&quot;Clonotype_1036&quot;, &quot;Clonotype_1050&quot;, &quot;Clonotype_10884&quot;,&quot;Clonotype_1457&quot;, &quot;Clonotype_755&quot;, &quot;Clonotype_322&quot;]</span>

<span class="n">isotypes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;IGHM&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;IGHG3&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;IGHG1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;IGHA1&#39;</span><span class="p">,</span><span class="s1">&#39;IGHG2&#39;</span><span class="p">,</span><span class="s1">&#39;IGHG4&#39;</span><span class="p">,</span><span class="s1">&#39;IGHE&#39;</span><span class="p">,</span><span class="s1">&#39;IGHA2&#39;</span><span class="p">]</span>
<span class="n">tr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Tribal</span><span class="p">(</span><span class="n">n_isotypes</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">isotypes</span><span class="p">),</span><span class="w"> </span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="w"> </span><span class="n">restarts</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">niter</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

<span class="c1">#run in refinement mode</span>
<span class="n">shm_score</span><span class="p">,</span><span class="w"> </span><span class="n">csr_likelihood</span><span class="p">,</span><span class="w"> </span><span class="n">best_scores</span><span class="p">,</span><span class="w"> </span><span class="n">transmat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">clonotypes</span><span class="o">=</span><span class="n">clonotypes</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;refinement&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">cores</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>

<span class="c1">#run in scoring mode</span>
<span class="n">shm_score</span><span class="p">,</span><span class="w"> </span><span class="n">csr_likelihood</span><span class="p">,</span><span class="w"> </span><span class="n">best_scores</span><span class="p">,</span><span class="w"> </span><span class="n">transmat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">clonotypes</span><span class="o">=</span><span class="n">clonotypes</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;score&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">cores</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>


<span class="c1">#given a user-specified isotype transition probability matrix </span>
<span class="kn">from</span><span class="w"> </span><span class="nn">tribal</span><span class="w"> </span><span class="kn">import</span><span class="w"> </span><span class="n">probabilites</span>
<span class="n">shm_score</span><span class="p">,</span><span class="w"> </span><span class="n">csr_likelihood</span><span class="p">,</span><span class="w"> </span><span class="n">best_scores</span><span class="p">,</span><span class="w"> </span><span class="n">transmat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tr</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">clonotypes</span><span class="w"> </span><span class="o">=</span><span class="n">clonotypes</span><span class="p">,</span>
<span class="w">                                                            </span><span class="n">transmat</span><span class="o">=</span><span class="w"> </span><span class="n">probabilites</span><span class="p">,</span>
<span class="w">                                                            </span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;refinement&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">cores</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
</code></pre></div>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>shm_score</code></td>            <td>
                  <code>float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>a float with the total somatic hypermutation (SHM) parsimony score for all clonotypes</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>csr_likelihood</code></td>            <td>
                  <code>float</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>a float with the total class switch recombination (CSR) likelihood score for all clonotypes</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>best_scores</code></td>            <td>
                  <code>dict</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>a dictionary of LineageTreeLists containing all optimal LineageTrees per clonotype</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>transmat</code></td>            <td>
                  <code><span title="numpy.array">array</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>a numpy array of isotype transition probabilities</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>

            <details class="quote">
              <summary>Source code in <code>tribal/tribal.py</code></summary>
              <div class="codehilite"><table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clonotypes</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;refinement&quot;</span><span class="p">,</span> <span class="n">transmat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cores</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run TRIBAL on a dictionary of clonotypes and infer B cell lineage tree(s)</span>
<span class="sd">    for each clonotype and a shared istoype transition probability matrix. </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    clonotypes: dict</span>
<span class="sd">        a dictionary of Clonotypes each containing a parsimony forest, isotypes and multiple sequence alignment    </span>
<span class="sd">    mode: str</span>
<span class="sd">        the mode for optimizing the class switch recombination (CSR) likelihood, one of [&quot;refinement&quot;, &quot;score&quot;]. In</span>
<span class="sd">        &#39;refinement&#39; mode, TRIBAL solves the most parsiminious tree refinement (MPTR) problem for each </span>
<span class="sd">        candidate tree in the parsimony forest. In &#39;score&#39; mode, TRIBAL  infers the ancestral isotypes using</span>
<span class="sd">        the Sankoff algorithm with the weights coming from the isotype transition probabilities. </span>
<span class="sd">    transmat: list</span>
<span class="sd">        a optional isotype transition probabilty matrix to infer a B cell lineage</span>
<span class="sd">        tree(s) for each clonotype. If not provided, the isotype transition probabilites</span>
<span class="sd">        are inferred from the data. </span>

<span class="sd">    cores: int</span>
<span class="sd">        The number of cores to use (default 1)</span>



<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    Here are examples of how to run the fit function::</span>

<span class="sd">        from tribal import Tribal, clonotypes</span>

<span class="sd">        #clonotypes dictionary includes the following clonotypes</span>
<span class="sd">        #[&quot;Clonotype_1036&quot;, &quot;Clonotype_1050&quot;, &quot;Clonotype_10884&quot;,&quot;Clonotype_1457&quot;, &quot;Clonotype_755&quot;, &quot;Clonotype_322&quot;]</span>

<span class="sd">        isotypes = [&#39;IGHM&#39;, &#39;IGHG3&#39;, &#39;IGHG1&#39;, &#39;IGHA1&#39;,&#39;IGHG2&#39;,&#39;IGHG4&#39;,&#39;IGHE&#39;,&#39;IGHA2&#39;]</span>
<span class="sd">        tr = Tribal(n_isotypes=len(isotypes), verbose=True, restarts=2, niter=15)</span>

<span class="sd">        #run in refinement mode</span>
<span class="sd">        shm_score, csr_likelihood, best_scores, transmat = tr.fit(clonotypes=clonotypes, mode=&quot;refinement&quot;, cores=6)</span>

<span class="sd">        #run in scoring mode</span>
<span class="sd">        shm_score, csr_likelihood, best_scores, transmat = tr.fit(clonotypes=clonotypes, mode=&quot;score&quot;, cores=6)</span>


<span class="sd">        #given a user-specified isotype transition probability matrix </span>
<span class="sd">        from tribal import probabilites</span>
<span class="sd">        shm_score, csr_likelihood, best_scores, transmat = tr.fit(clonotypes =clonotypes,</span>
<span class="sd">                                                                    transmat= probabilites,</span>
<span class="sd">                                                                    mode=&quot;refinement&quot;, cores=6)</span>



<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    shm_score: float</span>
<span class="sd">        a float with the total somatic hypermutation (SHM) parsimony score for all clonotypes</span>

<span class="sd">    csr_likelihood: float</span>
<span class="sd">        a float with the total class switch recombination (CSR) likelihood score for all clonotypes</span>

<span class="sd">    best_scores: dict </span>
<span class="sd">        a dictionary of LineageTreeLists containing all optimal LineageTrees per clonotype</span>

<span class="sd">    transmat: np.array</span>
<span class="sd">        a numpy array of isotype transition probabilities</span>


<span class="sd">    &quot;&quot;&quot;</span>




    <span class="bp">self</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span> 
    <span class="bp">self</span><span class="o">.</span><span class="n">nproc</span> <span class="o">=</span> <span class="n">cores</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">clonotypes</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The number of clonotypes is 0. Recheck data and try again.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Starting TRIBAL with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">clonotypes</span><span class="p">)</span><span class="si">}</span><span class="s2"> clonotypes...&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">transmat</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Inferring isotype transition probabilities...&quot;</span><span class="p">)</span>
        <span class="n">transmat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_infer_probabilities</span><span class="p">(</span><span class="n">clonotypes</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using provided isotype transition probabilities for CSR optimization...&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">transmat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_isotypes</span> <span class="ow">or</span> <span class="n">transmat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_isotypes</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;User provided isotype transition probability matrix does not match the number of isotype states&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Optimizing the CSR Likelihood...&quot;</span><span class="p">)</span>
    <span class="n">csr_likelihood</span><span class="p">,</span> <span class="n">best_scores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_csr_optimize</span><span class="p">(</span><span class="n">clonotypes</span><span class="p">,</span> <span class="n">transmat</span><span class="o">=</span><span class="n">transmat</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Reconstructing the ancestral sequences...&quot;</span><span class="p">)</span>

    <span class="n">shm_score</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">bst_lst</span> <span class="ow">in</span> <span class="n">best_scores</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">alignment</span> <span class="o">=</span> <span class="n">clonotypes</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">alignment</span>
        <span class="n">min_score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">Inf</span>
        <span class="k">for</span> <span class="n">lt</span> <span class="ow">in</span> <span class="n">bst_lst</span><span class="p">:</span>
            <span class="n">lt</span><span class="o">.</span><span class="n">ancestral_sequence_reconstruction</span><span class="p">(</span><span class="n">alignment</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">alphabet</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lt</span><span class="o">.</span><span class="n">shm_obj</span> <span class="o">&lt;</span> <span class="n">min_score</span><span class="p">:</span>
                <span class="n">min_score</span> <span class="o">=</span> <span class="n">lt</span><span class="o">.</span><span class="n">shm_obj</span>
        <span class="n">shm_score</span> <span class="o">+=</span> <span class="n">min_score</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SHM Score: </span><span class="si">{</span><span class="n">shm_score</span><span class="si">}</span><span class="s2"> CSR Likelihood: </span><span class="si">{</span><span class="n">csr_likelihood</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The TRIBE has spoken!&quot;</span><span class="p">)</span>
    <span class="k">return</span>  <span class="n">shm_score</span><span class="p">,</span> <span class="n">csr_likelihood</span><span class="p">,</span> <span class="n">best_scores</span><span class="p">,</span> <span class="n">transmat</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var tab,labels=set.querySelector(".tabbed-labels");for(tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.sections", "navigation.top", "navigation.path", "toc.integrate", "toc.collapsible", "search.suggest", "search.highlight", "content.code.annotation", "content.code.copy", "content.tabs.link"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.fe8b6f2b.min.js"></script>
      
    
  </body>
</html>