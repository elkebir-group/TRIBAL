configfile: "config.yaml"
reps = [i for i in range(config['nreps'])]
# reps = [i for i in range(51)]
clonotypes = [i+1 for i in range(config['size'][0])]
reps = [i for i in range(1,8)]
reps = [1,2,4,5]
reps = [3]
rule all:
    input:
        #infer the simulated transition matrix and compare with ground truth
        expand("sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/{clonotype}/likelihood.csv",
            n = config["ncells"],
            r = reps,
            k = config["size"],
            clonotype= clonotypes
        ),
        expand("sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal/inference_error.txt",
            n = config["ncells"],
            r = reps,
            k = config["size"],
        ),
        # #generate heatmaps for ground truth transition matrices  
        # # expand("sim_data/transmats/transmat{r}_heatmap.pdf",
        # #     r = reps
        # # ),
        expand( "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/{clonotype}/GCsim_{treetype}_tree.png",
            n = config["ncells"],
            # r = reps,
            r = reps,
            k = config["size"],
            clonotype= clonotypes ,
            treetype = ["collapsed", "lineage"]
        ),
        # expand("sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal_refine/{clonotype}/{alpha}/inferred_collapsed_tree.png",
        #     n = config["ncells"],
        #     r = reps,
        #     k = config["size"],
        #     alpha= [0.75],
        #     clonotype= clonotypes
        # ),
        #refine and score using inferred transition matrix
        expand("sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal_{mode}/{clonotype}/{alpha}/tree.png",
            n = config["ncells"],
            r = reps,
            k = config["size"],
            alpha=[0.75],
            clonotype= clonotypes,
            mode = ['score', 'refine'],
        ),
        #  #refine and score using ground truth transition matrix
        # expand("sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal_{mode}_gt/{clonotype}/{alpha}/tree_gt.png",
        #     n = config["ncells"],
        #     r = reps,
        #     k = config["size"],
        #     alpha=[0.75],
        #     clonotype= clonotypes,
        #     mode = ['score', 'refine'],
        # ),
        # #search using inferred transition matrix
        expand("sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal_{mode}/{clonotype}/{alpha}/search_tree.png",
            n = config["ncells"],
            r = reps,
            k = config["size"],
            alpha= config["alpha"],
            clonotype= clonotypes,
            mode = ['search']
        ),
        # expand("sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal_{mode}_gt/{clonotype}/{alpha}/tree_search_gt.png",
        #     n = config["ncells"],
        #     r = reps,
        #     k = config["size"],
        #     alpha= config["alpha"],
        #     clonotype= clonotypes,
        #     mode = ['search']
        # ),
        expand( "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/{clonotype}/{phylip}/tribal_tree.png",
            n = config["ncells"],
            r = reps,
            k = config["size"],
            clonotype= clonotypes,
            phylip = ['dnaml','dnapars', 'igphyml']

        )
        


    
        # expand("sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal/inference_error.txt",
        #     n = [config["ncells"]],
        #     r = reps,
        #     k = [config["size"]]
        # ),
  
        # expand("sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal_search_gt/{clonotype}/{alpha}/tree.png",
        #     n = [config["ncells"]],
        #     r = reps,
        #     k = [config["size"]],
        #     alpha= config["alpha"],
        #     clonotype= clonotypes 
        # ),
 
     
    

rule generate_gt_diagrams:
    input: 
        tmat = "sim_data/transmats/transmat{r}.txt",
        encoding = "sim_encoding.txt",
    output:
       pdf = "sim_data/transmats/transmat{r}.pdf",
       png = "sim_data/transmats/transmat{r}.png",
       heatmap = "sim_data/transmats/transmat{r}_heatmap.pdf"
    shell:
        "python ../src/draw_state_diagram.py -t {input.tmat} -e {input.encoding} "
        "-o {output.png} --pdf {output.pdf} --heatmap {output.heatmap} "


rule generate_gt_trees:
    input: 
        parents = "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/{clonotype}/GCsim_{treetype}_tree.parents",
        isotypes ="sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/{clonotype}/GCsim_{treetype}_tree.isotypes"
    output: "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/{clonotype}/GCsim_{treetype}_tree.png",
    shell:
        "python ../src/draw_tree.py -t {input.parents} -i {input.isotypes} -o {output}"


rule generate_inf_collapsed_trees:
    input: 
        parents = "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal_refine/{clonotype}/{alpha}/inferred_collapsed_tree.parents",
        isotypes ="sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal_refine/{clonotype}/{alpha}/inferred_collapsed_tree.isotype"
    output: "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal_refine/{clonotype}/{alpha}/inferred_collapsed_tree.png",
    shell:
        "python ../src/draw_tree.py -t {input.parents} -i {input.isotypes} -o {output}"


rule tribal_infer:
    input: 
        clonotypes = "clonotypes_size{k}.txt", 
        encoding = "sim_encoding.txt",
    params:
        inpath = "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365",
        max_cand = config["max_cand"],
        niter = config["niter"],
        thresh = config["threshold"],
        root = "naive",
        tree_path =  "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365",
        nworkers = config['nworkers'],
        restarts = config["nrestarts"],
        mu = config["mu"],
        sigma = config["sigma"],
        fasta = "GCsim_dedup.fasta",
        isotypes =  "GCsim.isotypes",
        candidates = "dnapars/outtree",
        jump_prob = config["jump_prob"]
    threads: config["nworkers"]
    output:
        transmat = "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal/transmat.txt",
        stateprobs = "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal/state_probs.txt",
        score ="sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal/fit_score.txt",
        diagram = "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal/diagram.png",
        diagram_pdf = "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal/diagram.pdf",
        heatmap = "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal/heatmap.pdf"
    benchmark: "benchmark/tribal_EM/cells{n}_size{k}_rep{r}.benchmark.log"
    log:
        std = "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal/fit.log",
        err = "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal/fit.err.log"
    shell:
        "python ../src/tribal.py -c {input.clonotypes} -p {params.inpath} --fasta {params.fasta} --isotypes {params.isotypes} "
        "-r {params.root} -e {input.encoding} -s {wildcards.r} --candidates {params.candidates} "
        "--niter {params.niter} -j {params.jump_prob} "
        "--thresh {params.thresh} --transmat_infer {output.transmat}  --tree_path {params.tree_path}  "
        "--state_probs {output.stateprobs} --score {output.score} --diagram_pdf {output.diagram_pdf}  "
        "--heatmap {output.heatmap} "
        "--nworkers {threads} --restarts {params.restarts} --mu {params.mu} --sigma {params.sigma} "
        "--diagram {output.diagram} > {log.std} 2> {log.err} "


rule compare_tmats:
    input: 
        gt= "transmats/transmat{r}.txt",
        infer =  "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal/transmat.txt",
        states = "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal/state_probs.txt",
    output: 
        mse = "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal/inference_error.txt",
        heatmapDiff ="sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal/transmat_diff.pdf",
        heatmapStates= "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal/state_heatmap.pdf",
        heatmapTrans= "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal/transmat_heatmap.pdf",
    params:
        bin_path = "../src"
    run:
    
        import numpy as np 
        import pandas as pd 
        import seaborn as sns 
        import matplotlib.pyplot as plt 
        import sys 
        sys.path.insert(0, params.bin_path)
     
        from draw_state_diagram import DrawStateDiag

        gt = np.loadtxt(input.gt)
     
        infer = np.loadtxt(input.infer)
        diff = np.abs(gt-infer)
       
        n = diff.shape[0]
        n_params = n*(n+1)/2
        se = np.square(diff)
        mse = np.sum(se)/n_params 
        mae = np.sum(diff)/n_params
        DrawStateDiag(diff).heatmap(output.heatmapDiff) 

        with open(output.mse, "w") as file:
            file.write("RMSE,MSE,MAE,nparams\n")
            file.write( f"{np.sqrt(mse)},{mse},{mae},{n_params}\n")

        isotypes = [ "IgM/D", "IgG3", "IgG1" ,  "IgG2b",  "IgG2c" , "IgE", "IgA"]
        
        plt.figure()
        states = np.loadtxt(input.states).reshape(1,-1)
   
        
      
        df = pd.DataFrame(states.reshape(1,-1), columns=isotypes)
        fig =sns.heatmap(df, annot=True, fmt=".02f", cmap="rocket_r", square=True, yticklabels=False, vmin=0, vmax=1)

        fig.set(xlabel="Isotype")
        plt.savefig(output.heatmapStates)
        plt.figure()
        df = pd.DataFrame(infer, index=isotypes, columns=isotypes)
        fig =sns.heatmap(df, annot=True, fmt=".02f", cmap="rocket_r", square=True, vmin=0, vmax=1)

        fig.set(xlabel="Isotype", ylabel="Isotype")
        plt.savefig(output.heatmapTrans)




rule tribal_refine_score:
    input: 
        alignment= "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/{clonotype}/GCsim_dedup.fasta",
        isotypes = "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/{clonotype}/GCsim.isotypes",
        transmat =   "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal/transmat.txt",
        candidates = "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/{clonotype}/dnapars/outtree",
        encoding = "sim_encoding.txt",
    output: 
        forest= "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal_{mode}/{clonotype}/{alpha}/forest.pickle",
        best_tree ="sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal_{mode}/{clonotype}/{alpha}/tree.txt",
        seq= "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal_{mode}/{clonotype}/{alpha}/inferred_seq.csv",
        fasta= "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal_{mode}/{clonotype}/{alpha}/inferred_seq.fasta",
        isotypes= "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal_{mode}/{clonotype}/{alpha}/isotypes.csv",
        score= "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal_{mode}/{clonotype}/{alpha}/score.csv",
        png = "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal_{mode}/{clonotype}/{alpha}/tree.png",
    params:
        root = "naive",
        ntrees = config["ntrees"]
    threads: config["nworkers"]
    log: 
        run= "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal_{mode}/{clonotype}/{alpha}/{mode}.log",
        err ="sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal_{mode}/{clonotype}/{alpha}/{mode}.err.log"  
    benchmark: "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal_{mode}/{clonotype}/{alpha}/{mode}.benchmark.log" 
    shell:
        "python ../src/tribal_sub.py "
        " -r {params.root} "
        "--candidates {input.candidates} "
        " -a {input.alignment} "
        "-t {input.transmat} "
        "-e {input.encoding} "
        "-i {input.isotypes} "
        "--alpha {wildcards.alpha} "
        "--sequences {output.seq} "
        "--fasta {output.fasta} "
        "--score {output.score} "
        "--iso_infer {output.isotypes} "
        "--png {output.png} "
        "--mode {wildcards.mode} "
        "--ntrees {params.ntrees} "
        "--nworkers {threads} "
        "--tree {output.best_tree} "
        "-o {output.forest} > {log.run} 2> {log.err} "  



rule tribal_search:
    input: 
        alignment= "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/{clonotype}/GCsim_dedup.fasta",
        isotypes = "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/{clonotype}/GCsim.isotypes",
        transmat =    "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal/transmat.txt",
        lin_forest =  "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal_refine/{clonotype}/0.75/forest.pickle",
        encoding = "sim_encoding.txt",
    output: 
        tree= "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal_search/{clonotype}/{alpha}/tree.txt",
        lin_forest =  "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal_search/{clonotype}/{alpha}/forest.pickle",
        seq= "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal_search/{clonotype}/{alpha}/inferred_seq.csv",
        fasta= "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal_search/{clonotype}/{alpha}/inferred_seq.fasta",
        isotypes= "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal_search/{clonotype}/{alpha}/isotypes.csv",
        score= "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal_search/{clonotype}/{alpha}/score.csv",
        png = "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal_search/{clonotype}/{alpha}/search_tree.png",
    params:
        root = "naive",
        timeout = config["search_timeout"],
        mode = "search",
        ntrees = config["ntrees"]
    threads: config['nworkers']
    log: 
        run= "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal_search/{clonotype}/{alpha}/search.log",
        err ="sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal_search/{clonotype}/{alpha}/search.err.log"  
    benchmark: "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal_search/{clonotype}/{alpha}/search.benchmark.log" 
    shell:
        "python ../src/tribal_sub.py "
        " -r {params.root} "
        " -a {input.alignment} "
        "-t {input.transmat} "
        "-e {input.encoding} "
        "-i {input.isotypes} "
        "-l {input.lin_forest} "
        "--forest "
        "--alpha {wildcards.alpha} "
        "--sequences {output.seq} "
        "--fasta {output.fasta} "
        "--score {output.score} "
        "--iso_infer {output.isotypes} "
        "--png {output.png} "
        "--mode {params.mode} "
        "--timeout {params.timeout} "
        "--nworkers {threads} "
        "--ntrees {params.ntrees} "
        "--tree {output.tree} "
        "-o {output.lin_forest} > {log.run} 2> {log.err} "  

rule tribal_search_gt:
    input: 
        alignment= "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/{clonotype}/GCsim_dedup.fasta",
        isotypes = "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/{clonotype}/GCsim.isotypes",
        transmat =  "transmats/transmat{r}.txt",
        lin_forest =  "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal_refine_gt/{clonotype}/0.75/forest_gt.pickle",
        encoding = "sim_encoding.txt",
    output: 
        tree= "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal_search_gt/{clonotype}/{alpha}/tree.txt",
        lin_forest =  "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal_search_gt/{clonotype}/{alpha}/forest.pickle",
        seq= "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal_search_gt/{clonotype}/{alpha}/inferred_seq.csv",
        fasta= "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal_search_gt/{clonotype}/{alpha}/inferred_seq.fasta",
        isotypes= "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal_search_gt/{clonotype}/{alpha}/isotypes.csv",
        score= "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal_search_gt/{clonotype}/{alpha}/score.csv",
        png = "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal_search_gt/{clonotype}/{alpha}/tree_search_gt.png",
    params:
        root = "naive",
        timeout = config["search_timeout"],
        mode = "search",
        ntrees = config["ntrees"]
    threads: config['nworkers']
    log: 
        run= "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal_search_gt/{clonotype}/{alpha}/search_gt.log",
        err ="sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal_search_gt/{clonotype}/{alpha}/search_gt.err.log"  
    benchmark: "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal_search_gt/{clonotype}/{alpha}/search_gt.benchmark.log" 
    shell:
        "python ../src/tribal_sub.py "
        " -r {params.root} "
        " -a {input.alignment} "
        "-t {input.transmat} "
        "-e {input.encoding} "
        "-i {input.isotypes} "
        "-l {input.lin_forest} "
        "--forest "
        "--alpha {wildcards.alpha} "
        "--sequences {output.seq} "
        "--fasta {output.fasta} "
        "--score {output.score} "
        "--iso_infer {output.isotypes} "
        "--png {output.png} "
        "--mode {params.mode} "
        "--timeout {params.timeout} "
        "--nworkers {threads} "
        "--ntrees {params.ntrees} "
        "--tree {output.tree} "
        "-o {output.lin_forest} > {log.run} 2> {log.err} "  







#run other trees through TRIBAL to get internal isotype labels
rule dnapars_isotype:
    input: 
        alignment= "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/{clonotype}/GCsim_dedup.fasta",
        isotypes = "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/{clonotype}/GCsim.isotypes",
        candidates = "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/{clonotype}/dnapars/outtree",
        encoding = "sim_encoding.txt",
        # transmat =  "transmats/transmat{r}.txt",
    output: 
        tree= "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/{clonotype}/dnapars/tribal_tree.txt",
        seq= "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/{clonotype}/dnapars/tribal_inferred_seq.csv",
        fasta= "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/{clonotype}/dnapars/tribal_inferred_seq.fasta",
        isotypes= "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/{clonotype}/dnapars/tribal_isotypes.csv",
        score= "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/{clonotype}/dnapars/score.csv",
        png = "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/{clonotype}/dnapars/tribal_tree.png",
    params:
        root = "naive",
        mode = "score",
        alpha = 0.75,
        all_path = "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/{clonotype}/dnapars",
        ntrees = 1000000
    threads: config['nworkers']
    log: 
        run= "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/{clonotype}/dnapars/dnapars_isotype.log",
        err ="sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/{clonotype}/dnapars/dnapars_isotype.err.log"  
    shell:
        "python ../src/tribal_sub.py "
        " -r {params.root} "
        "--candidates {input.candidates} "
        " -a {input.alignment} "
        "-e {input.encoding} "
        "-i {input.isotypes} "
        "--alpha {params.alpha} "
        "--sequences {output.seq} "
        "--fasta {output.fasta} "
        "--score {output.score} "
        "--iso_infer {output.isotypes} "
        "--png {output.png} "
        "--mode {params.mode} "
        "--nworkers {threads} "
        "--ntrees {params.ntrees} "
        "--save_candidates {params.all_path} "
        "--seed {wildcards.clonotype} "
        "--tree {output.tree} > {log.run} 2> {log.err} "  
    

rule dnaml_isotype:
    input: 
        alignment= "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/{clonotype}/GCsim_dedup.fasta",
        isotypes = "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/{clonotype}/GCsim.isotypes",
        candidates = "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/{clonotype}/dnaml/outtree",
        # transmat =  "transmats/transmat{r}.txt",
        encoding = "sim_encoding.txt",
    output: 
        tree= "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/{clonotype}/dnaml/tribal_tree.txt",
        seq= "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/{clonotype}/dnaml/tribal_inferred_seq.csv",
        fasta= "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/{clonotype}/dnaml/tribal_inferred_seq.fasta",
        isotypes= "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/{clonotype}/dnaml/tribal_isotypes.csv",
        score= "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/{clonotype}/dnaml/score.csv",
        png = "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/{clonotype}/dnaml/tribal_tree.png",
    params:
        root = "naive",
        mode = "score",
        alpha = 0.75,
        all_path = "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/{clonotype}/dnaml",
        ntrees = 1000000
    log: 
        run= "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/2.0/0.365/{clonotype}/dnaml/dnaml_isotype.log",
        err ="sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/2.0/0.365/{clonotype}/dnaml/dnaml_isotype.err.log"  
    shell:
        "python ../src/tribal_sub.py "
        " -r {params.root} "
        "--candidates {input.candidates} "
        " -a {input.alignment} "
        "-e {input.encoding} "
        "-i {input.isotypes} "
        "--alpha {params.alpha} "
        "--sequences {output.seq} "
        "--fasta {output.fasta} "
        "--score {output.score} "
        "--iso_infer {output.isotypes} "
        "--png {output.png} "
        "--mode {params.mode} "
        "--ntrees {params.ntrees} "
        "--save_candidates {params.all_path} "
        "--tree {output.tree}  > {log.run} 2> {log.err} "  


rule igphyml_isotype:
    input: 
        alignment= "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/{clonotype}/GCsim_dedup.fasta",
        isotypes = "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/{clonotype}/GCsim.isotypes",
        candidates = "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/{clonotype}/igphyml/GCsim.phylip_igphyml_tree.txt.outgroup",
        # transmat =  "transmats/transmat{r}.txt",
        encoding = "sim_encoding.txt",
    output: 
        tree= "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/{clonotype}/igphyml/tribal_tree.txt",
        seq= "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/{clonotype}/igphyml/tribal_inferred_seq.csv",
        fasta= "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/{clonotype}/igphyml/tribal_inferred_seq.fasta",
        isotypes= "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/{clonotype}/igphyml/tribal_isotypes.csv",
        score= "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/{clonotype}/igphyml/score.csv",
        png = "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/{clonotype}/igphyml/tribal_tree.png",
    params:
        root = "naive",
        mode = "score",
        alpha = 0.75,
        all_path = "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/{clonotype}/igphyml",
        ntrees = 1000000
    log: 
        run= "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/2.0/0.365/{clonotype}/igphyml/igphyml_isotype.log",
        err ="sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/2.0/0.365/{clonotype}/igphyml/igphyml_isotype.err.log"  
    shell:
        "python ../src/tribal_sub.py "
        " -r {params.root} "
        "--candidates {input.candidates} "
        " -a {input.alignment} "
        "-e {input.encoding} "
        "-i {input.isotypes} "
        "--alpha {params.alpha} "
        "--sequences {output.seq} "
        "--fasta {output.fasta} "
        "--score {output.score} "
        "--iso_infer {output.isotypes} "
        "--png {output.png} "
        "--mode {params.mode} "
        "--ntrees {params.ntrees} "
        "--save_candidates {params.all_path} "
        "--tree {output.tree}  > {log.run} 2> {log.err} " 


rule compute_true_likelihood:
    input:
        transmat =  "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/tribal/transmat.txt",
        tree = "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/{clonotype}/GCsim_collapsed_tree.parents",
        isotype = "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/{clonotype}/GCsim_collapsed_tree.isotypes",
        seq =  "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/{clonotype}/GCsim_collapsed_tree.sequences",
    output:"sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/{clonotype}/likelihood.csv"
    log: 
        std= "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/{clonotype}/likelihood.log",
        err= "sim_data/replicates/cells{n}/size{k}/rep{r}/2.0/0.365/{clonotype}/likelihood.err.log"
    shell:
        "python ../src/compute_true_likelihood.py --transmat {input.transmat} -t {input.tree} -i {input.isotype} -s {input.seq} -o {output} > {log.std} 2> {log.err} "
